Aa

# [DB] CASE

- `CASE` 문은 특정 상황에서 데이터를 변환하여 활용할 수 있음 
- `ELSE` 를 생략하는 경우 `NULL`값이 지정됨

````sql
CASE
	WHEN 조건식 THEN 식
	WHEN 조건식 THEN 식
	ELSE 식
END 
````

````sql
-- 단순 조회
SELECT Id, gender 
FROM healthcare 
LIMIT 5;

-- 성별 1(남자), 2(여자)
SELECT
		id, 
		CASE
			WHEN gender = 1 THEN '남자'
			WHEN gender = 2 THEN '여자'
				-- ELSE
		END AS 성별 
FROM halthcare
LIMIT 5;
````

```sql
-- 흡연에 리스트를 보기
SELECT DISTINCT smoking
FROM healthcare;

-- 흡연
SELECT
		id, 
		smoking,
		CASE
		   WHEN smoking = 1 THEN '비흡연자'
		   WHEN smoking = 2 THEN '흡연자'
		   WHEN smoking = 3 THEN '헤비스모커'
		   ELSE '무응답'
		END
FROM healthcare
LIMIT 50;
```

```sql
-- 나이에 따라서 구분
-- 청소년(~18), 청년(~40), 중장년(~90)
SELECT 
		frist_name,
		last_name,
		CASE 
			WHEN age <= 18 THEN '청소년'
			WHEN age <= 40 THEN '청년'
			WHEN age <= 90 TEHN '중장년'
			ELSE '노년'
		END
FROM users
LIMIT 10;
```



# [DB] 서브쿼리

- 특정한 값을 메인 쿼리에 반환하여 활용하는 것 
- 실제 테이블에 없는 기준을 이용한 검색이 가능함
- 서브 쿼리는 소괄호로 감싸서 사용하며, 메인 쿼리의 칼럼을 모두 사용할 수 있음
- 메인 쿼리는 서브 쿼리의 칼럼을 이용할 수 없음



### 단일행 서브쿼리

- 서브쿼리의 결과가 0 또는 1개인 경우
- 단일행 비교 연산자와 함께 사용 (=, <, <=, >=, >, <>)

````sql
-- 가장 나이가 작은 사람의 수 
-- 1
SELECT COUNT(*)
FROM users
GROUP BY age
ORDER BY age
LIMIT 1;
-- age  COUNT(*)
-- 15    39

-- 확인
SELECT MIN(age)
FROM users;
-- MIN(age)
-- -------
-- 15

SELECT COUNT(*)
FROM users
WHERE age = 15;
-- COUNT(*)
-- --------
-- 39


SELECT COUNT(*)
FROM users
WHERE age = (SELECT MIN(age) FROM users);
-- COUNT(*)
-- --------
-- 39


-- users 에서 평균 계좌 잔고가 높은 사람의 수는?
SELECT COUNT(*) 
FROM users
WHERE balance > (SELECT AVG(balance) FROM users);
-- COUNT(*)
-- --------
-- 222
````

````sql
-- users에서 유은정과 같은 지역에 사는 사람의 수는?
SELECT 
	  country,
FROM users
WHERE last_name = '유' AND first_name = '은정';

SELECT 
		COUNT(*)
FROM users
WEHRE county = (SELECT country, FROM users
WHERE last_name = '유' AND first_name = '은정';)
````

```sql
-- 전체 인원과 평균 연봉, 평균 나이를 출력
SELECT COUNT(*), AVG(balance), AVG(age)
FROM users;

SELECT 
		(SELECT COUNT(*) FROM users) AS 총인원,
		(SELECT AVG(balance) FROM users) AS 평균연봉;
```

- UPDATE에서의 활용

```sql
UPDATE users
SET balance = (SELECT AVG(balance) FROM users);
```



### 다중행 서브쿼리 

- 서브쿼리 결과가 2개 이상인 경우
- 다중행 비교 연선자와 함께 사용 (IN, EXISTS 등)

````sql
-- users에서 이은정과 같은 지역에 사는 사람의 수는?
SELECT 
	  country,
FROM users
WHERE last_name = '이' AND first_name = '은정';
-- country
----------
-- 전라북도
-- 경상북도

SELECT 
		COUNT(*)
FROM users
WHERE county IN (SELECT country, FROM users
WHERE last_name = '이' AND first_name = '은정';)
-- COUNT(*)
-- --------
-- 218
````



### 다중컬럼 서브쿼리

````sql
SELECT 
		last_name,
		first_name,
		age,
FROM users
WHERE (last_name,age) IN (SELECT last_name, MIN(age) FROM users GROUP BY last_name)
ORDER BY last_name;
````